<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Watcher | Vue.js 技术揭秘</title>
    <meta name="description" content="Analysis vue.js deeply">
    <link rel="icon" href="/vue-analysis/logo.png">
  <link rel="manifest" href="/vue-analysis/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/vue-analysis/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/vue-analysis/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/vue-analysis/assets/css/0.styles.05c98011.css" as="style"><link rel="preload" href="/vue-analysis/assets/js/app.279cf484.js" as="script"><link rel="preload" href="/vue-analysis/assets/js/2.40a76497.js" as="script"><link rel="preload" href="/vue-analysis/assets/js/23.834816b1.js" as="script"><link rel="prefetch" href="/vue-analysis/assets/js/10.ee26828d.js"><link rel="prefetch" href="/vue-analysis/assets/js/11.c08a3344.js"><link rel="prefetch" href="/vue-analysis/assets/js/12.e5a82f2d.js"><link rel="prefetch" href="/vue-analysis/assets/js/13.279f7877.js"><link rel="prefetch" href="/vue-analysis/assets/js/14.562888ca.js"><link rel="prefetch" href="/vue-analysis/assets/js/15.2670939a.js"><link rel="prefetch" href="/vue-analysis/assets/js/16.affd6fa0.js"><link rel="prefetch" href="/vue-analysis/assets/js/17.78b75465.js"><link rel="prefetch" href="/vue-analysis/assets/js/18.f9cec222.js"><link rel="prefetch" href="/vue-analysis/assets/js/19.64dfd141.js"><link rel="prefetch" href="/vue-analysis/assets/js/20.87eef84c.js"><link rel="prefetch" href="/vue-analysis/assets/js/21.e976be0e.js"><link rel="prefetch" href="/vue-analysis/assets/js/22.9966ac3b.js"><link rel="prefetch" href="/vue-analysis/assets/js/24.2697c917.js"><link rel="prefetch" href="/vue-analysis/assets/js/25.34ad69ca.js"><link rel="prefetch" href="/vue-analysis/assets/js/26.e7b58a56.js"><link rel="prefetch" href="/vue-analysis/assets/js/27.23e938b4.js"><link rel="prefetch" href="/vue-analysis/assets/js/28.98bbf8f5.js"><link rel="prefetch" href="/vue-analysis/assets/js/29.6f98ff49.js"><link rel="prefetch" href="/vue-analysis/assets/js/3.54bc6330.js"><link rel="prefetch" href="/vue-analysis/assets/js/30.1a031d69.js"><link rel="prefetch" href="/vue-analysis/assets/js/31.09b71de7.js"><link rel="prefetch" href="/vue-analysis/assets/js/32.44bf823e.js"><link rel="prefetch" href="/vue-analysis/assets/js/33.ce534ba7.js"><link rel="prefetch" href="/vue-analysis/assets/js/34.4b606534.js"><link rel="prefetch" href="/vue-analysis/assets/js/35.9feb4488.js"><link rel="prefetch" href="/vue-analysis/assets/js/36.18f84d2e.js"><link rel="prefetch" href="/vue-analysis/assets/js/37.ce975bc6.js"><link rel="prefetch" href="/vue-analysis/assets/js/38.4b119194.js"><link rel="prefetch" href="/vue-analysis/assets/js/39.0090387a.js"><link rel="prefetch" href="/vue-analysis/assets/js/4.c4832647.js"><link rel="prefetch" href="/vue-analysis/assets/js/40.1497ce8b.js"><link rel="prefetch" href="/vue-analysis/assets/js/41.f24aec6e.js"><link rel="prefetch" href="/vue-analysis/assets/js/42.34b128cc.js"><link rel="prefetch" href="/vue-analysis/assets/js/43.fc0f4a69.js"><link rel="prefetch" href="/vue-analysis/assets/js/44.2a811dcf.js"><link rel="prefetch" href="/vue-analysis/assets/js/45.a4f323e2.js"><link rel="prefetch" href="/vue-analysis/assets/js/46.cea2bde9.js"><link rel="prefetch" href="/vue-analysis/assets/js/47.720b270c.js"><link rel="prefetch" href="/vue-analysis/assets/js/48.ab7c842e.js"><link rel="prefetch" href="/vue-analysis/assets/js/49.05af5e00.js"><link rel="prefetch" href="/vue-analysis/assets/js/5.94740fb3.js"><link rel="prefetch" href="/vue-analysis/assets/js/50.887042cf.js"><link rel="prefetch" href="/vue-analysis/assets/js/51.325a6109.js"><link rel="prefetch" href="/vue-analysis/assets/js/52.2c99fb92.js"><link rel="prefetch" href="/vue-analysis/assets/js/53.c3e919ec.js"><link rel="prefetch" href="/vue-analysis/assets/js/54.3572897b.js"><link rel="prefetch" href="/vue-analysis/assets/js/55.3b165275.js"><link rel="prefetch" href="/vue-analysis/assets/js/56.c85450e7.js"><link rel="prefetch" href="/vue-analysis/assets/js/57.fbd1a42d.js"><link rel="prefetch" href="/vue-analysis/assets/js/58.c745aee4.js"><link rel="prefetch" href="/vue-analysis/assets/js/59.fb9be1bc.js"><link rel="prefetch" href="/vue-analysis/assets/js/6.f23794cd.js"><link rel="prefetch" href="/vue-analysis/assets/js/60.9f7a2bae.js"><link rel="prefetch" href="/vue-analysis/assets/js/61.2d64c117.js"><link rel="prefetch" href="/vue-analysis/assets/js/62.54efcba3.js"><link rel="prefetch" href="/vue-analysis/assets/js/63.95d1900f.js"><link rel="prefetch" href="/vue-analysis/assets/js/64.6d26ddcf.js"><link rel="prefetch" href="/vue-analysis/assets/js/65.676356d8.js"><link rel="prefetch" href="/vue-analysis/assets/js/66.c07aca85.js"><link rel="prefetch" href="/vue-analysis/assets/js/67.db5d3540.js"><link rel="prefetch" href="/vue-analysis/assets/js/68.035529f3.js"><link rel="prefetch" href="/vue-analysis/assets/js/69.7817f4ed.js"><link rel="prefetch" href="/vue-analysis/assets/js/7.f8370484.js"><link rel="prefetch" href="/vue-analysis/assets/js/70.8e15bc0d.js"><link rel="prefetch" href="/vue-analysis/assets/js/71.5407e52b.js"><link rel="prefetch" href="/vue-analysis/assets/js/72.673e18ff.js"><link rel="prefetch" href="/vue-analysis/assets/js/73.92268b89.js"><link rel="prefetch" href="/vue-analysis/assets/js/74.5d4e2acc.js"><link rel="prefetch" href="/vue-analysis/assets/js/75.ef613c3f.js"><link rel="prefetch" href="/vue-analysis/assets/js/8.30db71a3.js"><link rel="prefetch" href="/vue-analysis/assets/js/9.808c878d.js">
    <link rel="stylesheet" href="/vue-analysis/assets/css/0.styles.05c98011.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vue-analysis/" class="home-link router-link-active"><!----> <span class="site-name">Vue.js 技术揭秘</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vue-analysis/my/md/" class="nav-link router-link-active">my</a></div><div class="nav-item"><a href="/vue-analysis/v2/prepare/" class="nav-link">2.x 版本</a></div><div class="nav-item"><a href="/vue-analysis/v3/guide/" class="nav-link">3.x 版本</a></div> <a href="https://github.com/jiangxiaoxin/vue-analysis" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vue-analysis/my/md/" class="nav-link router-link-active">my</a></div><div class="nav-item"><a href="/vue-analysis/v2/prepare/" class="nav-link">2.x 版本</a></div><div class="nav-item"><a href="/vue-analysis/v3/guide/" class="nav-link">3.x 版本</a></div> <a href="https://github.com/jiangxiaoxin/vue-analysis" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>文章列表</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-analysis/my/md/" class="sidebar-link">Introduction</a></li><li><a href="/vue-analysis/my/md/vue-component.html" class="sidebar-link">VueComponent</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="watcher"><a href="#watcher" class="header-anchor">#</a> Watcher</h1> <p>参照<a href="/vue-analysis/my/md/htmls/watcher.html">watcher.html</a>的代码看问题。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token parameter">vm<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>
    expOrFn<span class="token punctuation">:</span> string <span class="token operator">|</span> Function<span class="token punctuation">,</span>
    cb<span class="token punctuation">:</span> Function<span class="token punctuation">,</span>
    options<span class="token operator">?</span><span class="token punctuation">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm
      vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
      <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Watcher</code>到底是个什么角色？在一个 Vue 实例(VueComponent 也是 Vue 实例)，如果实例针对某个“属性”发生变化时要触发一些操作，那这种“订阅”操作就由 Watcher 去代理。</p> <p>在 watcher.html 的代码里，当点击 button 时，<code>counter</code> 会发生改变，从而导致 p 标签显示发生变化，这是个 render 渲染过程，<code>vm</code> 创建了一个 <code>watcher</code> 专门来做这件事，创建时传入的第二个参数 <code>expOrFn</code> 是个回调方法，<code>updateComponent = () =&gt; {vm._update(vm._render(), hydrating)}</code>,这个 watcher 是个 render watcher，用来改变渲染的。那如果再加个 button，点击后改变另外个属性，也有个对应的 p 标签发生变化，会不会创建另外个 render watcher 呢？<strong>不会的</strong>。render watcher 的职责是渲染发生变化时修改 vm 的显示，而不是修改 vm 某个标签的显示，<strong>只有一个</strong>。但是这并不是说一个 vm 只有一个 watcher 哦。代码里有 watch 属性，它观察住另外两个属性 <code>counter</code> 和 <code>oddOrEven</code>，他们发生变化后会执行对应的操作，那这个时候就会分别创建对应的 <code>watcher</code> 实例，传入的 <code>expOrFn</code> 就是 <code>counter</code> 和 <code>oddOrEven</code>这俩字符串(所以源码里 <code>expOrFn</code> 的类型是 <code>String|Function</code>)，而 <code>cb</code> 就是 watch 里它们各自对应的回调方法了。所以打印 <code>vm</code> 的<code>_watchers</code> 属性里面有 3 个 watcher 实例。</p> <blockquote><p><code>vm._watcher</code> 是 <code>vm</code> 的 render watcher，只有一个，所有的更新操作都由它代理了。<code>vm._watchers</code> 是 vm 的所有的 watcher 的集合.</p></blockquote> <p>new Vue =&gt; this._init(options) =&gt; initState(vm) =&gt; initWatch(vm, opts.watch) =&gt; createWatcher(vm, key, handler) =&gt; vm.$watch(expOrFn, handler, options) =&gt; var watcher = new Watcher(vm, expOrFn, cb, options);</p> <p><code>flushSchedulerQueue</code> 会执行所有的 <code>watcher.run()</code> ，执行完后  <code>callUpdatedHooks(updatedQueue)</code>，在 <code>callUpdatedHooks</code> 里会对队列的 watcher 进行判断，如果 <code>watcher.vm._watcher === watcher</code> ，那这个 watcher 就是这个 vm 实例的 render watcher ，继续判断 <code>vm._isMounted</code> ,如果已经挂载了，就调用钩子函数 <code>callHook(vm, 'updated')</code> 完成一次更新.</p> <p><code>watcher.user</code> 表示这个 watcher 是用户自己定义的 watcher ，而不是 Vue 内部自己生成的，用于组件内的 watch 侦听器。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/jiangxiaoxin/vue-analysis/edit/master/docs/my/md/watcher.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">4/17/2020, 11:31:36 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/vue-analysis/assets/js/app.279cf484.js" defer></script><script src="/vue-analysis/assets/js/2.40a76497.js" defer></script><script src="/vue-analysis/assets/js/23.834816b1.js" defer></script>
  </body>
</html>
